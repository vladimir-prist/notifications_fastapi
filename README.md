redis-server
redis-cli
uvicorn notify.main:app --reload
celery -A notify.tasks.celery worker --loglevel=info -P eventlet

notifications_fastapi_bot

# Сервис рассылки на FastAPI
Данный сервис является частью микросервисной архитектуры, которая обеспечивает работу большого проекта в части 
уведомлений пользователей на email или в telegram.


## Использование
Для работы с данным проектом:

* Клонировать репозиторий. https://github.com/vladimir-prist/notification.git

* В виртуальном окружении установите **requirements.txt** (пакет с зависимостями) с помощью команды:
```sh
$ pip install -r requirements.txt
```
* Добавьте в свой проект файл **.env** необходимыми для работы паролями.
Пример **.env.sample** размещен в проекте.


## Настройка

1. Клонируйте репозиторий.

**https://github.com/vladimir-prist/notification.git**
2. Создайте виртуальное окружение.

```bash
python3 -m venv venv
source venv\scripts\activate
```
3. Установите зависимости.
```sh
pip install -r requirements.txt
```
4. Добавьте в свой проект файл **.env** необходимыми для работы паролями.
Пример **.env.sample** размещен в проекте.

## Запуск приложения

1. Вначале запустите брокера в отдельном терминале выполнив поочередно команды (в разных окнах):

```bash
redis-server
```

```bash
redis-cli
```

2. Запуск FastAPI:

```bash
uvicorn notify.main:app --reload
```

В данной команде часть notify.main:app означает следующее:

**notify.main** — это путь (имя модуля) к файлу Python, где лежит код приложения. 
В данном случае есть папка notify, в ней файл main.py.
**:app** — через двоеточие указывается объект (переменная, функция, класс), который нужно запустить как приложение. 
Обычно в FastAPI это переменная app = FastAPI() внутри файла main.py.
**--reload** — включает режим автоматической перезагрузки приложения при изменении исходного кода (удобно для разработки).

2. Запуск Celery:

```bash
celery -A notify.tasks.celery worker --loglevel=info -P eventlet
```

3. Откройте ваш браузер и перейдите по адресу `http://127.0.0.1:8000/docs`, чтобы увидеть документацию Swagger.


## Эндпоинты

### Создание напоминания

- **POST** `api/notify`
- Тело запроса:

```sh
{
"message_text": string(1024),
"recipient": string(150) | list[string(150)],
"delay": int
}
```
Параметр **message_text** содержит обычный текст, который будет отправлен в сообщении

Параметр **recipient** может содержать одного получателя или список получателей.
Для каждого получателя определен адрес отправки либо почта, либо telegram.
В получателе telegram всегда только числа, почта оформлена по общей маске почтового адреса.

Параметр **delay** отвечает за задержку отправки, где:

**0** - отправлять без задержки, при получении запроса

**1** - отправить с задержкой в 1 час

**2** - отправить с задержкой в 1 день

Напоминания в виде сообщений приходят от email указанного вами в **notidy/config.py FROM_EMAIL** 
Напоминания в Telegram приходят от ЧатБота, в данном случае **notifications_fastapi_bot**
P.S. для работы с Telegram-ChatBot необходимо найти ЧатБота и начать диалог /start 


При получении сообщение складываться в отдельную таблицу в БД.
А по результатам рассылки записывается лог о попытке отправки в БД.
Сама отправка должна осуществляется с помощью очереди через celery.


## Технические требования


1. **Язык программирования:**
    - Python 3.12
2. **Фреймворк:**
    - FastAPI 0.115.7 
3. **База данных:**
    - PostgreSQL для хранения данных
4. **ORM:**
    - Pydantic, SQLAlchemy ORM
5. **Документация:**
    - В корне проекта размещен файл README.md с описанием структуры проекта, инструкциями по установке и запуску, а также описанием API.
6. **Качество кода:**
    - Соблюдены стандарты PEP8 для Python кода.
